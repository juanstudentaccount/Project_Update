<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Shared Portfolio View – Executive Dashboard</title>
  <style>
  :root{
    --ink:#e8ecf1; --muted:#a9b2bd; --panel:#0f1420; --card:#121a29; --accent:#6aa3ff;
    --shadow:0 6px 24px rgba(0,0,0,.25); --ring:0 0 0 3px rgba(106,163,255,.28);
  }
  html,body{height:100%}
  body{
    margin:0; background:radial-gradient(1200px 800px at 10% -10%, #0b0d12 0%, #0f1320 100%);
    color:var(--ink); font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
    -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
  }
  *,*::before,*::after{box-sizing:border-box}

  .shell{max-width:1100px; margin:40px auto; padding:24px}
  header{position:sticky; top:0; z-index:3; background:rgba(15,19,32,.86); backdrop-filter:saturate(140%) blur(8px); border-bottom:1px solid rgba(255,255,255,.06);}
  header .inner{max-width:1100px; margin:0 auto; padding:14px 24px; display:flex; align-items:center; gap:16px}
  header h1{margin:0; font-size:28px; letter-spacing:.2px}
  .pill{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid rgba(255,255,255,.12); background:#0d1421; border-radius:999px; color:var(--muted); font-size:13px}

  .pmo{margin:24px 0; padding:20px; border-radius:16px; background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01)); border:1px solid rgba(255,255,255,.06); box-shadow:var(--shadow);}
  .pmo h2{margin:0 0 6px 0}
  .exec{display:grid; gap:12px; margin-bottom:16px}
  .toolbar{display:flex; align-items:center; gap:10px; margin:10px 0}
  .toolbar .spacer{flex:1}

  /* Badges */
  .badges{display:flex; gap:8px; flex-wrap:wrap}
  .badge{display:inline-flex; align-items:center; gap:8px; padding:10px 12px; border-radius:12px; background:var(--card); border:1px solid rgba(255,255,255,.06); font-size:12px; color:var(--muted)}
  .dot{width:10px; height:10px; border-radius:50%}
  .dot.g{background:#28c76f} .dot.y{background:#ffcc00} .dot.r{background:#ff4d4f}

  /* Tiles */
  .tiles{display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:12px; margin:6px 0 18px}
  .tile{
    display:flex; align-items:center; justify-content:center; gap:12px; padding:12px 14px; min-height:44px;
    border:1px solid rgba(255,255,255,.12); background:var(--card); border-radius:12px; text-decoration:none; color:var(--ink); font-weight:600; box-shadow:var(--shadow)
  }
  .tile:hover{border-color:rgba(106,163,255,.55); background:linear-gradient(180deg,rgba(106,163,255,.10),rgba(255,255,255,.00))}
  .tile:focus-visible{outline:none; box-shadow:var(--ring)}

  /* Summary block */
  .summary-card{background:var(--card); border:1px solid rgba(255,255,255,.06); border-radius:14px; padding:14px 16px; box-shadow:var(--shadow)}
  .summary-head{display:flex; align-items:baseline; gap:10px; margin:0 0 8px 0}
  .summary-head h3{margin:0; font-size:16px; letter-spacing:.2px}
  .summary-hint{color:var(--muted); font-size:12px}
  #execSummary{
    min-height:64px; outline:none; border-radius:10px; padding:10px 12px;
    background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.00)); border:1px solid rgba(255,255,255,.08);
  }
  #execSummary:focus{box-shadow:var(--ring)}
  [contenteditable][data-placeholder]:empty::before{content: attr(data-placeholder); color:var(--muted);}

  /* Form */
  .form{
    display:grid; grid-template-columns:1fr 1fr;
    grid-template-areas:"date health" "summary highlights" "risks next" "actions actions";
    gap:12px; margin:10px 0 16px; align-items:start
  }
  @media (max-width: 900px){
    .form{grid-template-columns:1fr; grid-template-areas:"date" "health" "summary" "highlights" "risks" "next" "actions"}
  }
  .field{display:flex; flex-direction:column; gap:6px; margin:0}
  .field--date{grid-area:date} .field--health{grid-area:health} .field--summary{grid-area:summary}
  .field--highlights{grid-area:highlights} .field--risks{grid-area:risks} .field--next{grid-area:next}
  .field--actions{grid-area:actions; display:flex; justify-content:flex-end}
  .field label{margin:0 0 4px 0; font-size:12px; color:var(--muted)}
  input[type="text"], input[type="date"], textarea, select{
    width:100%; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.12);
    background:var(--card); color:var(--ink); outline:none
  }
  input[type="text"]:focus, input[type="date"]:focus, textarea:focus, select:focus{box-shadow:var(--ring)}
  select{height:44px} textarea{min-height:64px; resize:vertical} textarea#updSummary{min-height:96px}

  .list{display:grid; gap:12px}
  .empty{
    background:var(--card); border:1px dashed rgba(255,255,255,.15); border-radius:14px; padding:16px;
    color:var(--muted); font-size:14px; text-align:center
  }

  details.update{background:var(--card); border:1px solid rgba(255,255,255,.06); border-radius:16px; box-shadow:var(--shadow); overflow:hidden}
  details.update + details.update{margin-top:12px}
  details.update summary{list-style:none; cursor:pointer; padding:14px 16px; display:flex; align-items:center; gap:10px; user-select:none}
  details.update summary::-webkit-details-marker{display:none}
  .summary-row{display:flex; align-items:center; gap:10px; width:100%}
  .summary-row .spacer{flex:1}
  .summary-meta{display:flex; gap:12px; color:var(--muted); font-size:12px}
  .update-body{padding:0 16px 16px}
  .update-body p{margin:0}

  .btn{cursor:pointer; font-weight:600; padding:8px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:var(--card); color:var(--ink);}
  .btn:hover{border-color:rgba(106,163,255,.55)}
  .btn.small{padding:6px 10px; font-size:12px; border-radius:10px}
  .btn.primary{background:#0b3df2; border-color:#0b3df2}
  .btn.primary:hover{filter:brightness(1.1)}
  .btn.ghost{background:transparent; border-color:rgba(255,255,255,.18); color:var(--ink)}
  .controls{display:flex; gap:8px}
  </style>
</head>
<body>
  <header>
    <div class="inner">
      <h1>Team Status Updates</h1>
      <span class="pill" id="connStatus">Local-only (no backend)</span>
    </div>
  </header>

  <div class="shell">
    <section class="pmo" id="portfolio-view" aria-label="Executive Portfolio View">

      <div class="exec">
        <div class="toolbar">
          <h2>Portfolio View</h2>
          <div class="spacer"></div>
        </div>

        <!-- Executive Summary block -->
        <div class="summary-card" aria-labelledby="summaryTitle">
          <div class="summary-head">
            <h3 id="summaryTitle">Summary</h3>
            <span class="summary-hint">Write 3–5 sentences on portfolio status, themes, and top risks.</span>
            <div class="spacer"></div>
            <button class="btn ghost small" id="clearSummaryBtn" type="button">Clear Summary</button>
          </div>
          <div id="execSummary"
               contenteditable="true"
               role="textbox"
               aria-multiline="true"
               data-placeholder="Click to write the executive summary..."></div>
        </div>

        <!-- Editable counters -->
        <div class="badges" role="list" style="margin-top:8px">
          <div class="badge"><span class="dot g"></span> <span id="ctGreen" contenteditable="true" tabindex="0">0</span> On Track</div>
          <div class="badge"><span class="dot y"></span> <span id="ctYellow" contenteditable="true" tabindex="0">0</span> At Risk</div>
          <div class="badge"><span class="dot r"></span> <span id="ctRed" contenteditable="true" tabindex="0">0</span> Off Track</div>
          <div class="badge">Total: <b id="ctTotal">0</b> projects</div>
        </div>
        <div class="summary-hint">Tip: click the numbers to edit counts.</div>
      </div>

      <div class="toolbar">
        <h3>Project Charters</h3>
        <div class="spacer"></div><div class="spacer"></div>
      </div>
      <div class="tiles" id="tiles" aria-label="Project charter tiles">
        <a class="tile" href="https://adiaz341.github.io/Project-Charter/" target="_blank" rel="noopener noreferrer">Alejandro Diaz</a>
        <a class="tile" href="https://ryanhwang2.github.io/Week-7-Homework-2-Charter-Iteration/" target="_blank" rel="noopener noreferrer">Ryan Hwang</a>
        <a class="tile" href="https://winterguy123.github.io/jyan.github.io/" target="_blank" rel="noopener noreferrer">Jeremy Yan</a>
        <a class="tile" href="https://juanstudentaccount.github.io/Updated-Project-Charter/" target="_blank" rel="noopener noreferrer">Juan Talome</a>
        <a class="tile" href="https://alexis-s-pinon.github.io/4860-project-charter/" target="_blank" rel="noopener noreferrer">Alexis Pinon</a>
      </div>

      <div class="toolbar"><h3>Team Status Updates</h3><div class="spacer"></div></div>
      <div class="form" id="updateForm">
        <div class="field field--date"><label for="updDate">Date</label><input type="date" id="updDate"></div>
        <div class="field field--health"><label for="updHealth">Health</label>
          <select id="updHealth">
            <option value="green">On Track</option>
            <option value="yellow">At Risk</option>
            <option value="red">Off Track</option>
          </select>
        </div>
        <div class="field field--summary"><label for="updSummary">Summary (2–3 sentences)</label><textarea id="updSummary" placeholder="Concise update in a consistent, professional tone"></textarea></div>

        <!-- Labels updated to remove '(comma-separated)' -->
        <div class="field field--highlights"><label for="updHighlights">Highlights</label><textarea id="updHighlights" placeholder="Key wins, progress"></textarea></div>
        <div class="field field--risks"><label for="updRisks">Challenges / Risks</label><textarea id="updRisks" placeholder="Issues, dependencies"></textarea></div>
        <div class="field field--next"><label for="updNext">Next Week Focus</label><textarea id="updNext" placeholder="Immediate priorities"></textarea></div>

        <div class="actions field--actions"><button class="btn primary" id="addUpdateBtn" type="button">Add Update</button></div>
      </div>

      <div class="toolbar">
        <h3>Recent Updates</h3>
        <div class="spacer"></div>
        <div class="controls">
          <button class="btn ghost small" id="expandAllBtn" type="button">Expand All</button>
          <button class="btn ghost small" id="collapseAllBtn" type="button">Collapse All</button>
        </div>
      </div>
      <div class="list" id="updatesList" aria-label="Recent team updates">
        <div class="empty" id="emptyState">No updates yet — add this week's update using the form above.</div>
      </div>

    </section>
  </div>

  <!-- Switch to a module script to use Supabase ESM -->
  <script type="module">
  /*
    Shared persistence via Supabase (client-only). Steps:
    1) Create a Supabase project and copy your URL and anon key below.
    2) Create tables:

       -- team updates
       create table if not exists public.updates (
         id text primary key,
         date text,
         owner text,
         health text check (health in ('green','yellow','red')) default 'green',
         summary text,
         highlights jsonb default '[]'::jsonb,
         risks jsonb default '[]'::jsonb,
         next jsonb default '[]'::jsonb,
         created_at timestamptz default now()
       );

       -- exec summary + counters (single row, id='default')
       create table if not exists public.portfolio_meta (
         id text primary key,
         exec_summary text,
         green integer default 0,
         yellow integer default 0,
         red integer default 0,
         updated_at timestamptz default now()
       );
       insert into public.portfolio_meta (id) values ('default')
       on conflict (id) do nothing;

    3) Turn on Row Level Security. Add permissive policies for quick testing (tighten later):
       -- updates
       create policy "updates anon read" on public.updates for select using (true);
       create policy "updates anon write" on public.updates for insert with check (true);
       create policy "updates anon update" on public.updates for update using (true);
       create policy "updates anon delete" on public.updates for delete using (true);

       -- portfolio_meta
       create policy "meta anon read" on public.portfolio_meta for select using (true);
       create policy "meta anon write" on public.portfolio_meta for insert with check (true);
       create policy "meta anon update" on public.portfolio_meta for update using (true);

    4) Deploy this HTML on GitHub Pages. Everyone will read/write the shared tables.
  */

  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  // === CONFIGURE THESE TWO VALUES ===
  const SUPABASE_URL = "https://YOUR_PROJECT.supabase.co";
  const SUPABASE_ANON_KEY = "YOUR_ANON_KEY";
  // ==================================

  const supaReady = SUPABASE_URL.startsWith("https://") && !SUPABASE_URL.includes("YOUR_PROJECT") && !SUPABASE_ANON_KEY.includes("YOUR_ANON_KEY");
  const supabase = supaReady ? createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : null;

  // Show connection status
  const conn = document.getElementById("connStatus");
  if (conn) conn.textContent = supaReady ? "Connected (shared via Supabase)" : "Local-only (no backend)";

  // Optional tiles data (defensive rendering)
  const PMO_LINKS = [
    "https://adiaz341.github.io/Project-Charter/",
    "https://ryanhwang2.github.io/Week-7-Homework-2-Charter-Iteration/",
    "https://winterguy123.github.io/jyan.github.io/",
    "https://juanstudentaccount.github.io/Updated-Project-Charter/",
    "https://alexis-s-pinon.github.io/4860-project-charter/"
  ];
  const PMO_NAMES = ["Alejandro Diaz","Ryan Hwang","Jeremy Yan","Juan Talome","Alexis Pinon"];

  // Keys for offline cache (used as fallback + perf cache)
  const UPDATES_KEY = "pmo_team_updates_v3";
  const SUM_KEY     = "pmo_exec_summary_v3";
  const G_KEY       = "pmo_exec_green_v2";
  const Y_KEY       = "pmo_exec_yellow_v2";
  const R_KEY       = "pmo_exec_red_v2";

  // Clean older saved data once
  (()=>{
    const oldKeys = ["pmo_team_updates_v1","pmo_team_updates_v2","pmo_exec_summary_v1","pmo_exec_summary_v2","pmo_exec_green_v1","pmo_exec_yellow_v1","pmo_exec_red_v1"];
    try{ oldKeys.forEach(k=>localStorage.removeItem(k)); }catch{}
  })();

  // Helpers
  const $ = (s,r=document)=>r.querySelector(s);
  const el=(tag,cls,txt)=>{ const n=document.createElement(tag); if(cls) n.className=cls; if(txt!==undefined) n.textContent=txt; return n; };
  const uid=()=> Date.now().toString(36)+Math.random().toString(36).slice(2,7);
  const parseList=(s)=> (s||"").split(/[\n,;•]+/).map(v=>v.trim()).filter(Boolean);

  // Local cache helpers
  const loadUpdatesLocal = ()=>{ try{ return JSON.parse(localStorage.getItem(UPDATES_KEY) || "[]"); } catch { return []; } };
  const saveUpdatesLocal = (arr)=>{ try{ localStorage.setItem(UPDATES_KEY, JSON.stringify(arr)); } catch {} };

  // Remote (Supabase) helpers
  async function remoteLoadUpdates() {
    const { data, error } = await supabase
      .from("updates")
      .select("*")
      .order("date", { ascending: false })
      .order("created_at", { ascending: false });
    if (error) throw error;
    return (data || []).map(u => ({
      id: u.id, date: u.date, owner: u.owner, health: u.health,
      summary: u.summary, highlights: u.highlights || [], risks: u.risks || [], next: u.next || []
    }));
  }
  async function remoteUpsertUpdate(u) {
    const { error } = await supabase.from("updates").upsert(u, { onConflict: "id" });
    if (error) throw error;
  }
  async function remoteDeleteUpdate(id) {
    const { error } = await supabase.from("updates").delete().eq("id", id);
    if (error) throw error;
  }
  async function remoteLoadMeta() {
    const { data, error } = await supabase.from("portfolio_meta").select("*").eq("id","default").maybeSingle();
    if (error) throw error;
    return data || null;
  }
  async function remoteSaveMeta(meta) {
    const payload = { id: "default", ...meta };
    const { error } = await supabase.from("portfolio_meta").upsert(payload, { onConflict: "id" });
    if (error) throw error;
  }

  // State
  let TEAM_UPDATES = loadUpdatesLocal(); // start with cache; will be replaced by remote if available
  let EDIT_ID = null;

  // Tiles
  function renderTiles(){
    const root=$("#tiles"); if(!root) return; root.innerHTML='';
    (PMO_LINKS||[]).forEach((url,i)=>{
      const a=el('a','tile', (PMO_NAMES||[])[i] || url);
      a.href=url; a.target='_blank'; a.rel='noopener noreferrer'; a.title=(PMO_NAMES||[])[i] || url;
      root.appendChild(a);
    });
  }

  // Health chip
  function healthChip(h){
    const chip=el('span','health'); const dot=el('span','dot '+(h==='green'?'g':h==='yellow'?'y':'r'));
    chip.appendChild(dot); chip.appendChild(el('span','', h==='green'?'On Track':(h==='yellow'?'At Risk':'Off Track')));
    return chip;
  }

  // Updates
  function renderUpdates(){
    const list=$("#updatesList"); if(!list) return; list.innerHTML='';
    if(!TEAM_UPDATES.length){
      const empty=el('div','empty',"No updates yet — add this week's update using the form above.");
      empty.id='emptyState';
      list.appendChild(empty);
      return;
    }
    const items=[...TEAM_UPDATES].sort((a,b)=> (b.date||'').localeCompare(a.date||'') || (b.id||'').localeCompare(a.id||''));
    items.forEach((u,idx)=>{
      const det=document.createElement('details'); det.className='update'; if(idx===0) det.open=true; det.dataset.id=u.id;

      const sum=document.createElement('summary');
      const row=el('div','summary-row');
      row.appendChild(el('strong','', `Update – ${u.date||''}`));
      row.appendChild(el('span','spacer'));
      const meta=el('div','summary-meta'); meta.appendChild(el('span','', u.owner||'PMO')); meta.appendChild(healthChip(u.health||'green'));
      row.appendChild(meta);
      sum.appendChild(row); det.appendChild(sum);

      const body=el('div','update-body');
      body.appendChild(el('p','', 'Summary: ' + (u.summary || '-')));
      body.appendChild(el('p','', 'Highlights: ' + ((u.highlights||[]).join(' • ')||'-')));
      body.appendChild(el('p','', 'Challenges / Risks: ' + ((u.risks||[]).join(' • ')||'-')));
      body.appendChild(el('p','', 'Next Week Focus: ' + ((u.next||[]).join(' • ')||'-')));

      const actions=el('div','actions');
      const editBtn=el('button','btn small','Edit'); editBtn.type='button';
      const delBtn=el('button','btn ghost small','Delete'); delBtn.type='button';
      editBtn.addEventListener('click',(e)=>{ e.preventDefault(); startEditById(u.id); });
      delBtn.addEventListener('click', async (e)=>{
        e.preventDefault();
        if (supaReady) {
          try { await remoteDeleteUpdate(u.id); } catch {}
        } else {
          deleteByIdLocal(u.id);
        }
        await refreshFromSource();
      });
      actions.appendChild(editBtn); actions.appendChild(delBtn);
      body.appendChild(actions);

      det.appendChild(body);
      list.appendChild(det);
    });
  }

  // Executive Summary + counters
  function renderSummaryFromLocal(){
    const sEl=$("#execSummary"), gEl=$("#ctGreen"), yEl=$("#ctYellow"), rEl=$("#ctRed"), tEl=$("#ctTotal");
    if(!sEl||!gEl||!yEl||!rEl||!tEl) return;
    try{
      const sVal=localStorage.getItem(SUM_KEY);
      const gVal=localStorage.getItem(G_KEY);
      const yVal=localStorage.getItem(Y_KEY);
      const rVal=localStorage.getItem(R_KEY);
      sEl.textContent = sVal ?? "";
      gEl.textContent = gVal ?? "0";
      yEl.textContent = yVal ?? "0";
      rEl.textContent = rVal ?? "0";
    }catch{}
    updateTotal();
  }

  function updateTotal(){
    const gEl=$("#ctGreen"), yEl=$("#ctYellow"), rEl=$("#ctRed"), tEl=$("#ctTotal");
    if(!gEl||!yEl||!rEl||!tEl) return;
    const toInt = (el)=>{ const n=parseInt((el.textContent||'0').replace(/[^\d-]/g,''),10); return isFinite(n)?Math.max(0,n):0; };
    tEl.textContent = String(toInt(gEl)+toInt(yEl)+toInt(rEl));
  }

  function attachSummaryHandlers(){
    const sEl=$("#execSummary"), gEl=$("#ctGreen"), yEl=$("#ctYellow"), rEl=$("#ctRed");
    if(!sEl||!gEl||!yEl||!rEl) return;

    const toInt = (el)=>{ const n=parseInt((el.textContent||'0').replace(/[^\d-]/g,''),10); return isFinite(n)?Math.max(0,n):0; };

    const persistCountsLocal = ()=>{
      try{
        localStorage.setItem(G_KEY, String(toInt(gEl)));
        localStorage.setItem(Y_KEY, String(toInt(yEl)));
        localStorage.setItem(R_KEY, String(toInt(rEl)));
      }catch{}
      updateTotal();
    };
    const persistCountsRemote = async ()=>{
      if (!supaReady) return;
      try{
        await remoteSaveMeta({
          green: toInt(gEl),
          yellow: toInt(yEl),
          red: toInt(rEl),
        });
      }catch{}
      updateTotal();
    };
    const persistSummaryLocal = ()=>{ try{ localStorage.setItem(SUM_KEY, sEl.textContent||""); }catch{} };
    const persistSummaryRemote = async ()=>{
      if (!supaReady) return;
      try{ await remoteSaveMeta({ exec_summary: sEl.textContent || "" }); }catch{}
    };

    ["input","blur","keyup"].forEach(ev=>{
      gEl.addEventListener(ev, ()=>{ persistCountsLocal(); persistCountsRemote(); });
      yEl.addEventListener(ev, ()=>{ persistCountsLocal(); persistCountsRemote(); });
      rEl.addEventListener(ev, ()=>{ persistCountsLocal(); persistCountsRemote(); });
    });
    ["input","blur"].forEach(ev=> sEl.addEventListener(ev, ()=>{ persistSummaryLocal(); persistSummaryRemote(); }));

    $("#clearSummaryBtn")?.addEventListener('click', ()=>{
      sEl.textContent="";
      try{ localStorage.removeItem(SUM_KEY); }catch{}
      if (supaReady) remoteSaveMeta({ exec_summary: "" }).catch(()=>{});
      sEl.focus();
      updateTotal();
    });
  }

  // Add/Edit/Delete (local)
  function startEditById(id){
    const u=TEAM_UPDATES.find(x=>x.id===id); if(!u) return;
    $("#updDate").value=u.date||'';
    $("#updHealth").value=u.health||'green';
    $("#updSummary").value=u.summary||'';
    $("#updHighlights").value=(u.highlights||[]).join('\\n');
    $("#updRisks").value=(u.risks||[]).join('\\n');
    $("#updNext").value=(u.next||[]).join('\\n');
    $("#addUpdateBtn").textContent='Save Update';
    EDIT_ID=id;
    $("#updateForm").scrollIntoView({behavior:'smooth', block:'start'});
  }

  function deleteByIdLocal(id){
    const i=TEAM_UPDATES.findIndex(x=>x.id===id); if(i<0) return;
    TEAM_UPDATES.splice(i,1); saveUpdatesLocal(TEAM_UPDATES); renderUpdates();
  }

  async function addOrSaveUpdate(){
    const d=$("#updDate").value || new Date().toISOString().slice(0,10);
    const h=$("#updHealth").value || 'green';
    const s=($("#updSummary").value||'').trim();
    const hl=parseList($("#updHighlights").value);
    const rk=parseList($("#updRisks").value);
    const nx=parseList($("#updNext").value);

    if (supaReady){
      // Remote upsert
      const id = EDIT_ID || uid();
      const row = { id, date:d, owner:'PMO', health:h, summary:s, highlights:hl, risks:rk, next:nx };
      try { await remoteUpsertUpdate(row); } catch (e) { console.error(e); }
      EDIT_ID=null; $("#addUpdateBtn").textContent='Add Update';
      await refreshFromSource();
    } else {
      // Local-only
      if(EDIT_ID){
        const i=TEAM_UPDATES.findIndex(x=>x.id===EDIT_ID);
        if(i>=0) TEAM_UPDATES[i] = { ...TEAM_UPDATES[i], date:d, health:h, summary:s, highlights:hl, risks:rk, next:nx };
        EDIT_ID=null; $("#addUpdateBtn").textContent='Add Update';
      }else{
        TEAM_UPDATES.push({ id: uid(), date:d, owner:'PMO', health:h, summary:s, highlights:hl, risks:rk, next:nx });
      }
      saveUpdatesLocal(TEAM_UPDATES);
      renderUpdates();
    }

    ['updSummary','updHighlights','updRisks','updNext'].forEach(id=>{ const el=$("#"+id); if(el) el.value=''; });
  }

  // Expand/Collapse
  const expandAllUpdates=()=> document.querySelectorAll('details.update').forEach(d=>d.open=true);
  const collapseAllUpdates=()=> document.querySelectorAll('details.update').forEach(d=>d.open=false);

  // Refresh from correct source
  async function refreshFromSource(){
    if (supaReady){
      try {
        TEAM_UPDATES = await remoteLoadUpdates();
        // Mirror to cache for offline
        saveUpdatesLocal(TEAM_UPDATES);
      } catch (e) {}
    } else {
      TEAM_UPDATES = loadUpdatesLocal();
    }
    renderUpdates();

    // Load meta (summary + counts)
    if (supaReady){
      try {
        const meta = await remoteLoadMeta();
        if (meta){
          const sEl=$("#execSummary"), gEl=$("#ctGreen"), yEl=$("#ctYellow"), rEl=$("#ctRed");
          if (sEl) sEl.textContent = meta.exec_summary || "";
          if (gEl) gEl.textContent = String(meta.green ?? 0);
          if (yEl) yEl.textContent = String(meta.yellow ?? 0);
          if (rEl) rEl.textContent = String(meta.red ?? 0);
          // mirror to local
          try{
            localStorage.setItem(SUM_KEY, meta.exec_summary || "");
            localStorage.setItem(G_KEY, String(meta.green ?? 0));
            localStorage.setItem(Y_KEY, String(meta.yellow ?? 0));
            localStorage.setItem(R_KEY, String(meta.red ?? 0));
          }catch{}
        } else {
          // No meta yet -> render from local
          renderSummaryFromLocal();
        }
      } catch (e){ renderSummaryFromLocal(); }
      updateTotal();
    } else {
      renderSummaryFromLocal();
    }
  }

  // Realtime subscriptions (optional)
  function setupRealtime(){
    if (!supaReady) return;
    const channel = supabase.channel("dashboard-updates");
    channel
      .on("postgres_changes", { event: "*", schema: "public", table: "updates" }, () => {
        refreshFromSource();
      })
      .on("postgres_changes", { event: "*", schema: "public", table: "portfolio_meta" }, () => {
        refreshFromSource();
      })
      .subscribe();
  }

  // Init
  document.addEventListener('DOMContentLoaded', async ()=>{
    renderTiles();
    attachSummaryHandlers();
    await refreshFromSource();
    setupRealtime();

    $("#addUpdateBtn")?.addEventListener('click', (e)=>{ e.preventDefault(); addOrSaveUpdate(); });
    $("#expandAllBtn")?.addEventListener('click',(e)=>{ e.preventDefault(); expandAllUpdates(); });
    $("#collapseAllBtn")?.addEventListener('click',(e)=>{ e.preventDefault(); collapseAllUpdates(); });
  });
  </script>
</body>
</html>
